# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```

## Данные и типы данных приложения

Данные товара
``` TypeScript
interface IProduct {
  id: string;
  description:  string;
  image: string;
  title: string;
  category: ProductCategory;
  price: number;
}
```
Методы оплаты
``` TypeScript
enum PaymentMethod {
  online = 'online',
  offline = 'offline'
}
```

Для категории товара используется `enum`
``` TypeScript
enum ProductCategory {
  soft = 'софт-скил',
  hard = 'хард-скил',
  other = 'другое',
  additional = 'дополнительное',
  button = 'кнопка'
}
```

Данные покупателя

``` TypeScript
interface IConsumerInfo {
  payment: PaymentMethod | '';
  address: string;
  email: string;
  phone: string;
}
```
Данные для форм оформления заказа
``` TypeScript
type TConsumerAddressAndPayment = Pick<IConsumerInfo, 'address' | 'payment'>;
type TConsumerContacts = Pick<IConsumerInfo, 'email' | 'phone'>;
```

Тип для хранения информации о валидности данных в модели.
``` TypeScript
type ValidationErrors = Partial<Record<keyof IConsumerInfo, string>>;
```

Данные, передаваемые на сесвер при оформлении заказа
``` TypeScript
export interface IOrder extends Partial<IConsumerInfo> {
  total: number;
  items: string[];
}
```

Ответ от сервера при успешном оформлении заказа
``` TypeScript
interface ISuccessOrderAnswer {
  total: number;
  id: string;
}
```

## Архитектура проекта

Архитектура приложения выстроена согласно подходам MVP.\
Компоненты приложения разделены на следующие слои:
- слой данных, отвечает за хранение и изменение данных
- слой представления, отвечает за отображение данных на странице,
- презентер, отвечает за связь представления и данных.\

Слой представления генерирует события черех брокер событий и это вызывает методы слоя данных. 
Также изменения данных в модели генерируют события, которые вызывают методы слоя отображения. 
Связка слушателей и событий, основная логика приложения находится в слое перзентера.\
В исходный код добавлен базовый класс Component, от которого наслудются все классы слоя отображения.

### Базовый код
#### Класс Api
Содержит в себе базовую логику отправки запросов. В конструктор передается базовый адрес сервера и опциональный объект с заголовками запросов.
Методы: 
- `get` - выполняет GET запрос на переданный в параметрах ендпоинт и возвращает промис с объектом, которым ответил сервер
- `post` - принимает объект с данными, которые будут переданы в JSON в теле запроса, и отправляет эти данные на ендпоинт переданный как параметр при вызове метода. По умолчанию выполняется `POST` запрос, но метод запроса может быть переопределен заданием третьего параметра при вызове.

#### Класс EventEmitter
Брокер событий позволяет отправлять события и подписываться на события, происходящие в системе. Класс используется в презентере для обработки событий и в слоях приложения для генерации событий.  
Основные методы, реализуемые классом описаны интерфейсом `IEvents`:
- `on` - подписка на событие
- `emit` - инициализация события
- `trigger` - возвращает функцию, при вызове которой инициализируется требуемое в параметрах событие   
- `onAll` - метод для подписки на все события
- `offAll` - метод для сброса всех обработчиков

#### Класс Component
Базовый класс для компонентов отображения. Конструктор принимает `protected container: HTMLElement`, который и будет потом выдаваться методом `render`. 
Также класс имеет метод render(): HTMLElement, который возвращает элемент для отображения на странице. 

### Слой данных
#### Класс ProductsModel
Класс отвечает за хранение данных о товарах и отвечает за их изменение и работу над ними.\
Изменение массива товаров генерирует событие `model:products:change`.
Конструктор класса принимает инстант брокера событий.
В полях класса хранятся следующие данные:
- protected events: EventEmitter - экземпляр класса `EventEmitter` для инициации событий при изменении данных.
- productList: IProduct[] - массив товаров, доступных в ларьке.

Так же класс предоставляет набор методов для взаимодействия с этими данными.
- getProduct(id: string): IProduct - метод возвращает объект товара из `productList` по его уникальному `id`.
- геттер для получения массива товаров.

#### Класс BasketModel
Класс отвеает за хранение данных о содержимом корзинки и отвечает за изменение этих данных.\
Конструктор класса принимает инстант брокера событий. Любое изменение данных в массиве товаров в корзине генерирует событие `model:basket:change`.
В полях класса хранятся следующие данные:
- protected events: EventEmitter - экземпляр класса `EventEmitter` для инициации событий при изменении данных.
- basket: Map<string, number> - массив уникальных `id` товаров, добавленных в корзину.
- basketPrice: number - общая стоимость всех товаров, добавленных в корзину.
- itemsNumber: number | null - количество товаров в корзине.

Так же класс предоставляет набор методов для взаимодействия с этими данными.
- addToBasket(data: Pick<IProduct, 'id' | 'price'>): void - добавляет выбранный товар в `basket`.
- removeFromBasket(id: string): void - удаляет выбранный товар из массива `basket`.
- clearBasket(): void - метод очищения корзины.
- isInBasket(id: string): boolean - проверка есть ли товар в корзине.
- геттеры для получения данных из полей класса.

#### Класс ConsumerModel
Класс отвеает за хранение данных о покупателе и способе оплаты и отвечает за изменение этих данных.\
Конструктор класса принимает инстант брокера событий
В полях класса хранятся следующие данные:
- events: EventEmitter - экземпляр класса `EventEmitter` для инициации событий при изменении данных.
- consumerInfo: Partial<IConsumerInfo> - информация покупателя, которая будет храниться в этом свойстве.
- errors: ValidationErrors - информация о валидности данных в модели.

Так же класс предоставляет набор методов для взаимодействия с этими данными.
- addConsumerAddress(data: TConsumerAddressAndPayment): void - добавляет данные в поле `address` свойства `consumerInfo`.
- addConsumerContacts(data: TConsumerContacts): void - добавляет данные в поля `email` и `phone` свойства `consumerInfo`.
- clearData(): void - метод для очистки данных о пользователе, методе оплаты и ошибках.
- геттер для получения данных из полей класса.
- validate() - метод проверяет данные при каждом их изменении и меняет свойство `errors`.
- addressIsValid(): void - метод возвращает `true` если поля `payment` и `address` свойства `consumerInfo` валидны.
- contactIsValid(): void - метод возвращает `true` если поля `email` и `phone` свойства `consumerInfo` валидны.

### Слой отображения
#### Класс BasketIconUI
Класс реализует счетчик товаров на главной странице. Расширяет базовый класс `Component`. Нажатие на элемент генерирует событие `ui:basketIcon:click`. 
- _counter: HTMLSpanElement - элемент отображения счетчика корзина.

#### Класс CardUI
Расширяет базовый класс `Component`. Отвечает за отображение карточки, задавая в карточке данные названия, изображения, описания, стоимости, категории. Имеет 3 вида отображения на странице: `card` (отображение на главной странице), `card_full` (отображение в модальном окне), `card_compact` (отображение в корзине). В зависисмости от переданного в конструктор DOM элемент вызывается определнный метод, который настраивает поведение карточки в зависимости от темплейта и других услвоий. В классе устанавливаются слушатели на все интерактивные элементы, в результате взаимодействия с которыми пользователя генерируются соответствующие события. Нажатие на карточку `card` генерирует событие `ui:card:pick`.
Поля класса содержат элементы разметки элементов карточки. Конструктор, кроме элемента, клонированного из темплейта, принимает экземпляр EventEmitter для инициации событий.
Методы:
- setForBasket(cardData: IProduct): void - метод принимает данные товара и формирует объект для карточки товара в окне корзины.
- setIndex(index: number): void - устанавливает номер карточки в корзине.
- setForPreview(cardData: IProduct): void - метод принимает данные товара и формирует объект для карточки товара в окне предпросмотра. 
- setForCatalog(cardData: IProduct): void - метод принимает данные товара и формирует объект для карточки товара на главной странице.
- changeButtonState(inBasket: boolean): void - метод устанваливает атрибут `disabled` для кнопки добавления в корзину и ее текст. Принимает булево значение нахождения товара в корзине.

#### Класс BasketUI
Расширяет базовый класс `Component`. Отвечает за отображение содержимого модального окна корзины. Кнопка оформления заказа может быть как активной так и неактивной. 
Свойтсва:
- basketButton: HTMLButtonElement - элемент кнопки старта оформления заказа.
- basketPrice: HTMLElement - элемент для отображения полной суммы заказа.
- basketContainer: HTMLElement - элемент, который будет содержать карточки товаров в корзине.

Методы:
- setBasketItems(items: HTMLElement[]): void - изменение списка карточек товаров корзины.
- setTotalPrice(price: number): void - изменение полной стоимости заказа.
- disableOrderButton(status: boolean) - изменение состояния кнопки оформления заказа. 

#### Класс ModalUI
Класс отвечает за отображение модального окна. Так же предоставляет методы `open` и `close` для управления отображением модального окна. Устанавливает слушатели на клавиатуру, для закрытия модального окна по Esc, на клик в оверлей и кнопку-крестик для закрытия попапа.
В модальное окно будет возможно добавлять любое содержимое.
Поля класса:
- modal: HTMLElement - элемент модального окна
- events: IEvents - брокер событий
- container: HTMLElement - элемент, в котором будет отображаться содержимое модального окна.
- onClose: () => void - функция, выполняющаяся при закрытии модального окна.

Методы:
- constructor(selector: HTMLElement, events: EventEmitter) - Конструктор принимает элемент модального окна и экземпляр класса EventEmitter для возможности инициации событий.
- setContent(element: HTMLElement): void - метод, добавляющий содержимое модального окна.
- setOnClose(fn: () => void) - метод устанавливает функцию `onClose`, которая будет выполняться при закрытии модального окна. В частности убирает фиксацию скрола окна при открытом модальном окне.

#### Класс FormUI
Расширяет базовый класс `Component`. Является родительским абстрактным классом для всех форм проекта.
Свойства:
- protected error: HTMLElement - элемент для отображения ошибки при вводе пользователем данных.
- protected submitButton: HTMLButtonElement - свойство хранит элемент кнопки отправки данных из формы.
- protected container: HTMLFormElement - переопределяем свойство родительского класса, так как данный класс описывает форму.

Методы:
- disableOrderButton(status: boolean) - изменение состояния кнопки оформления заказа.
- reset() - очистка формы.

#### Класс ContactsFormUI
Расширяет класс `FormUI`. Предназначен для создания формы добавления данных покупателя при оформлении заказа. Хранит два поля ввода `emailElement` и `phoneElement`. Нажатие кнопки `submit` генерирует событие `ui:contactsForm:submit`.
Методы:
- onInputChange(): void - метод генерирует событие `ui:contactsForm:inputChange` при каждом изменение содержимого полей ввода и отправляет значения полей ввода.
- setValidationErrors(errors: ValidationErrors): void - устанавливает текст ошибки в поле `error`, которые получает в виде объекта `errors: ValidationErrors`.

#### Класс OrderFormUI
Расширяет класс `FormUI`. Предназначен для создания формы выбора способа оплаты и адреса доставки. 
Свойства:
- buttonCard: HTMLButtonElement - кнопка выбора метода оплаты картой.
- buttonCash: HTMLButtonElement - кнопка выбора метода оплаты наличными.
- inputAddress: HTMLInputElement - элемент поля ввода адреса. Изменение содержимого поля ввода вызывает защищенный метод `onInputChange`, который генерирует событие `ui:orderForm:inputChange`.
- protected paymentMethod: PaymentMethod | '' - поле хранит выбранный метод оплаты, для дальнейшей отправки в модель данных. В это свойство записывается метод оплаты при нажатии на кнопки выбора метода оплаты. Нажатие этих кнопок вызывают защищенный метод `onInputChange`, который генерирует событие `ui:orderForm:inputChange`.

Методы:
- protected onInputChange(): void - метод генерирует событие `ui:orderForm:inputChange` при каждом изменение содержимого полей ввода и отправляет данные формы.
- setValidationErrors(errors: ValidationErrors): void - устанавливает текст ошибки в поле `error`, которые получает в виде объекта `errors: ValidationErrors`.

##### Класс Success
Расширяет базовый класс `Component`. Класс отвечает за отображение содержимого модального окна с подтверждением оформления заказа. 
Свойства:
- totalPrice: HTMLElement - элемент для отображения полной суммы оформленного заказа.
- orderSuccessButton: HTMLButtonElement - кнопка закрытия модального окна для продолжения работы с магазином. Нажатие генерирует событие `ui:success:close`.

### Презентер
В проекте слой презентера отдельно не выделен. Вся основная логика проекта представлена в файле `index.ts`.
Взаимодействие выделенных слоев отображения и данных осуществляется за счет событий генерируемых с помощью брокера событий и обработчиков этих событий, описанных в `index.ts`\
В `index.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.

### *Список всех событий, которые могут генерироваться в системе:*
#### *События изменения данных (генерируются классами моделями данных)*
- `model:products:change` - изменение массива товаров.
- `model:basket:change` - изменение массива товаров в корзине.
- `model:products:previewChange` - изменение открываемой в модальном окне товара.
- `model:consumer:errorsChange` - изменение валидности данных о пользователе в модели.

#### *События, генерируемые при действиях пользователя (генерируются классами отображения)*
- `ui:basketIcon:click` - событие нажатия на иконку корзинки на главной странице. Должен вызывать открытие модального окна с содержимым корзины.
- `ui:card:pick` - событие генериуется при нажатии карточки на главной странице. 
- `ui:card:buy` - добвления товара в корзину.
- `ui:card:removeFromBusket` - событие генерируется при нажатии кнопки удаления товара из корзины из модального окна с карточкой товара. 
- `ui:modal:open` - генерируется при открытии модального окна.
- `ui:modal:close` - генерируется при закрытии модального окна.
- `ui:basket:order` - событие генерируется при нажатии кнопки оформление заказа в корзине.
- `ui:basket:removeFromBusket` - событие генерируется при нажатии кнопки удаления товара из корзины из модального окна с корзиной.
- `ui:contactsForm:submit` - событие генерируется при нажатии кнопки "Оплатить" в форме `ContactsForm`.
- `ui:contactsForm:inputChange` - событие генерируется при изменении полей ввода формы `ContactsForm`.
- `ui:orderForm:submit` - событие генерируется при нажатии кнопки "Далее" в форме `OrderForm`.
- `ui:orderForm:inputChange` - событие генерируется при изменении полей ввода формы `OrderForm`.
- `ui:success:close` - событие генерируется при нажатии кнопки "За новыми покупками!".